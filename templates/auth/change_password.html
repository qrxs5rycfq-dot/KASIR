{% extends "base.html" %}

{% block title %}Ganti Password - Dapoer Teras Obor{% endblock %}

{% block body %}
<div class="min-h-screen flex items-center justify-center p-4">
    <!-- Background decoration -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary-500/20 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-accent-500/20 rounded-full blur-3xl"></div>
    </div>
    
    <div class="w-full max-w-md relative z-10">
        <!-- Logo & Title -->
        <div class="text-center mb-8 animate-fade-in">
            <div class="w-20 h-20 rounded-2xl mx-auto mb-4 bg-yellow-500/20 flex items-center justify-center">
                <i class="fas fa-shield-alt text-4xl text-yellow-400"></i>
            </div>
            <h1 class="text-3xl font-display font-bold gradient-text">Ganti Password</h1>
            <p class="text-gray-400 mt-2">Untuk keamanan, silakan ganti password Anda</p>
        </div>
        
        <!-- Change Password Card -->
        <div class="glass-card rounded-2xl p-8 animate-fade-in" style="animation-delay: 0.1s">
            {% if current_user.force_password_change %}
            <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-xl p-4 mb-6">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5"></i>
                    <div>
                        <p class="text-yellow-300 font-medium">Keamanan Penting</p>
                        <p class="text-yellow-200/70 text-sm">Anda menggunakan password default. Silakan ganti dengan password baru untuk keamanan akun Anda.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <form method="POST" action="{{ url_for('change_password') }}" class="space-y-5">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Current Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Password Saat Ini</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" name="current_password" id="current_password" required
                               class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-12 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition"
                               placeholder="Masukkan password saat ini">
                        <button type="button" onclick="togglePassword('current_password', 'toggle-icon-1')" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="toggle-icon-1"></i>
                        </button>
                    </div>
                </div>
                
                <!-- New Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Password Baru</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-key"></i>
                        </span>
                        <input type="password" name="new_password" id="new_password" required
                               class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-12 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition"
                               placeholder="Masukkan password baru"
                               onkeyup="checkPasswordStrength()">
                        <button type="button" onclick="togglePassword('new_password', 'toggle-icon-2')" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="toggle-icon-2"></i>
                        </button>
                    </div>
                    <!-- Password Strength Indicator -->
                    <div class="mt-2">
                        <div class="h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="password-strength-bar" class="h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="password-strength-text" class="text-xs text-gray-500 mt-1">Minimal 8 karakter, 1 huruf besar, 1 huruf kecil, 1 angka</p>
                    </div>
                </div>
                
                <!-- Confirm Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Konfirmasi Password Baru</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-gray-400">
                            <i class="fas fa-check-double"></i>
                        </span>
                        <input type="password" name="confirm_password" id="confirm_password" required
                               class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-12 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition"
                               placeholder="Ulangi password baru"
                               onkeyup="checkPasswordMatch()">
                        <button type="button" onclick="togglePassword('confirm_password', 'toggle-icon-3')" class="absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400 hover:text-white">
                            <i class="fas fa-eye" id="toggle-icon-3"></i>
                        </button>
                    </div>
                    <p id="password-match-text" class="text-xs text-gray-500 mt-1"></p>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submit-btn" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center space-x-2">
                    <i class="fas fa-save"></i>
                    <span>Simpan Password Baru</span>
                </button>
                
                {% if not current_user.force_password_change %}
                <a href="{{ url_for('dashboard') }}" class="w-full block text-center text-gray-400 hover:text-white py-2">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Dashboard
                </a>
                {% endif %}
            </form>
        </div>
        
        <!-- Security Tips -->
        <div class="mt-6 p-4 bg-white/5 rounded-xl animate-fade-in" style="animation-delay: 0.2s">
            <h3 class="text-sm font-medium text-gray-300 mb-2 flex items-center">
                <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
                Tips Password Aman
            </h3>
            <ul class="text-xs text-gray-500 space-y-1">
                <li>• Gunakan kombinasi huruf besar, huruf kecil, dan angka</li>
                <li>• Jangan gunakan informasi pribadi (nama, tanggal lahir)</li>
                <li>• Jangan gunakan password yang sama dengan akun lain</li>
                <li>• Ganti password secara berkala (minimal 3 bulan sekali)</li>
            </ul>
        </div>
    </div>
</div>

<script>
function togglePassword(inputId, iconId) {
    const password = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    
    if (password.type === 'password') {
        password.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        password.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const bar = document.getElementById('password-strength-bar');
    const text = document.getElementById('password-strength-text');
    
    let strength = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) {
        strength += 25;
    } else {
        feedback.push('minimal 8 karakter');
    }
    
    // Uppercase check
    if (/[A-Z]/.test(password)) {
        strength += 25;
    } else {
        feedback.push('1 huruf besar');
    }
    
    // Lowercase check
    if (/[a-z]/.test(password)) {
        strength += 25;
    } else {
        feedback.push('1 huruf kecil');
    }
    
    // Number check
    if (/[0-9]/.test(password)) {
        strength += 25;
    } else {
        feedback.push('1 angka');
    }
    
    // Update bar
    bar.style.width = strength + '%';
    
    if (strength <= 25) {
        bar.className = 'h-full bg-red-500 transition-all duration-300';
        text.className = 'text-xs text-red-400 mt-1';
    } else if (strength <= 50) {
        bar.className = 'h-full bg-orange-500 transition-all duration-300';
        text.className = 'text-xs text-orange-400 mt-1';
    } else if (strength <= 75) {
        bar.className = 'h-full bg-yellow-500 transition-all duration-300';
        text.className = 'text-xs text-yellow-400 mt-1';
    } else {
        bar.className = 'h-full bg-green-500 transition-all duration-300';
        text.className = 'text-xs text-green-400 mt-1';
    }
    
    if (feedback.length > 0) {
        text.textContent = 'Perlu: ' + feedback.join(', ');
    } else {
        text.textContent = '✓ Password kuat!';
    }
    
    checkPasswordMatch();
}

function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const text = document.getElementById('password-match-text');
    const btn = document.getElementById('submit-btn');
    
    if (confirm.length === 0) {
        text.textContent = '';
        return;
    }
    
    if (password === confirm) {
        text.textContent = '✓ Password cocok';
        text.className = 'text-xs text-green-400 mt-1';
    } else {
        text.textContent = '✗ Password tidak cocok';
        text.className = 'text-xs text-red-400 mt-1';
    }
}
</script>
{% endblock %}
