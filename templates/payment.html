<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Pembayaran - Dapoer Teras Obor</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Midtrans Snap -->
    {% if config.MIDTRANS_IS_PRODUCTION %}
    <script src="https://app.midtrans.com/snap/snap.js" data-client-key="{{ config.MIDTRANS_CLIENT_KEY }}"></script>
    {% else %}
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ config.MIDTRANS_CLIENT_KEY }}"></script>
    {% endif %}
    
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .success-animation {
            animation: success-bounce 0.6s ease-out;
        }
        
        @keyframes success-bounce {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="font-sans">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Header with Logo -->
            <div class="text-center mb-8">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Dapoer Teras Obor" class="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg">
                <h1 class="text-2xl font-bold text-white">Dapoer Teras Obor</h1>
                <p class="text-gray-400">Pembayaran Online</p>
            </div>
            
            <!-- Payment Card -->
            <div class="glass-card rounded-2xl p-6 shadow-xl">
                <!-- Order Info -->
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-500/20 text-primary-400 mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Order #{{ order.order_number }}</h2>
                    <p class="text-gray-400 text-sm">{{ order.created_at.strftime('%d %B %Y, %H:%M') }}</p>
                </div>
                
                <!-- Order Items -->
                <div class="space-y-3 mb-6 max-h-48 overflow-y-auto">
                    {% for item in order.items %}
                    <div class="flex justify-between items-center text-gray-300 bg-white/5 rounded-lg p-3">
                        <div class="flex-1">
                            <span class="block font-medium">{{ item.menu_item.name }}</span>
                            <span class="text-sm text-gray-500">{{ item.quantity }}x @ Rp {{ "{:,.0f}".format(item.price) }}</span>
                        </div>
                        <span class="font-semibold">Rp {{ "{:,.0f}".format(item.subtotal) }}</span>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Divider -->
                <div class="border-t border-white/10 my-4"></div>
                
                <!-- Total -->
                <div class="flex justify-between items-center mb-6">
                    <span class="text-lg text-gray-300">Total Pembayaran</span>
                    <span class="text-2xl font-bold text-primary-400">Rp {{ "{:,.0f}".format(order.total) }}</span>
                </div>
                
                <!-- Status Display (hidden initially) -->
                <div id="statusDisplay" class="hidden mb-6 text-center">
                    <div id="successStatus" class="hidden">
                        <div class="success-animation inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-500/20 text-green-400 mb-4">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-green-400">Pembayaran Berhasil!</h3>
                        <p class="text-gray-400 mt-2">Terima kasih atas pesanan Anda</p>
                    </div>
                    <div id="pendingStatus" class="hidden">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-yellow-500/20 text-yellow-400 mb-4">
                            <svg class="w-10 h-10 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-yellow-400">Menunggu Pembayaran</h3>
                        <p class="text-gray-400 mt-2">Silakan selesaikan pembayaran Anda</p>
                    </div>
                    <div id="errorStatus" class="hidden">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-500/20 text-red-400 mb-4">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-red-400">Pembayaran Gagal</h3>
                        <p class="text-gray-400 mt-2">Silakan coba lagi</p>
                    </div>
                </div>
                
                <!-- Pay Button -->
                <button id="payButton" onclick="openPayment()" 
                        class="w-full py-4 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold rounded-xl 
                               hover:from-primary-600 hover:to-primary-700 transition-all duration-200 
                               flex items-center justify-center space-x-2 pulse-animation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <span>Bayar Sekarang</span>
                </button>
                
                <!-- Back Button (hidden initially) -->
                <a id="backButton" href="{{ url_for('orders') }}" 
                   class="hidden w-full mt-4 py-3 bg-white/10 text-white font-semibold rounded-xl text-center 
                          hover:bg-white/20 transition-all duration-200">
                    Kembali ke Pesanan
                </a>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 text-gray-500 text-sm">
                <p>Pembayaran aman dengan</p>
                <p class="font-semibold text-gray-400">Midtrans Payment Gateway</p>
            </div>
        </div>
    </div>
    
    <!-- PrinterManager is loaded from base.html - no need to load again -->
    
    <script>
        const snapToken = "{{ snap_token }}";
        const orderId = {{ order.id }};
        
        // CSRF Token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        // Override fetch to include CSRF token
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            if (url.toString().startsWith('/') || url.toString().startsWith(window.location.origin)) {
                options.headers = options.headers || {};
                if (!(options.headers instanceof Headers)) {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
            }
            return originalFetch(url, options);
        };
        
        // Order data for printing
        const orderData = {
            id: {{ order.id }},
            order_number: "{{ order.order_number }}",
            customer_name: "{{ order.customer_name or '' }}",
            table: "{{ order.table.number if order.table else '' }}",
            subtotal: {{ order.subtotal }},
            tax: {{ order.tax }},
            discount: {{ order.discount }},
            total: {{ order.total }},
            items: [
                {% for item in order.items %}
                {
                    name: "{{ item.name }}",
                    quantity: {{ item.quantity }},
                    price: {{ item.price }},
                    subtotal: {{ item.subtotal }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            payment: {
                payment_method: "Online",
                paid_amount: {{ order.total }},
                change_amount: 0
            }
        };
        
        // ESC/POS Commands for building receipt data
        const ESC_POS = {
            INIT: [0x1B, 0x40],
            ALIGN_CENTER: [0x1B, 0x61, 0x01],
            ALIGN_LEFT: [0x1B, 0x61, 0x00],
            BOLD_ON: [0x1B, 0x45, 0x01],
            BOLD_OFF: [0x1B, 0x45, 0x00],
            DOUBLE_HEIGHT: [0x1B, 0x21, 0x10],
            NORMAL_SIZE: [0x1B, 0x21, 0x00],
            CUT_PAPER: [0x1D, 0x56, 0x00],
            FEED_LINE: [0x0A],
            FEED_LINES: (n) => [0x1B, 0x64, n],
        };
        
        // Format number with thousand separator
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        // Build receipt commands
        function buildReceiptCommands(order, copyNum, totalCopies) {
            const encoder = new TextEncoder();
            let commands = [];
            
            const copyLabels = ['Kasir', 'Pelanggan', 'Dapur'];
            const copyLabel = copyLabels[copyNum - 1] || `Copy ${copyNum}`;
            
            commands.push(...ESC_POS.INIT);
            commands.push(...ESC_POS.ALIGN_CENTER);
            commands.push(...ESC_POS.BOLD_ON);
            commands.push(...encoder.encode('================================\n'));
            commands.push(...encoder.encode(' DAPOER TERAS OBOR\n'));
            commands.push(...encoder.encode('================================\n'));
            commands.push(...ESC_POS.BOLD_OFF);
            commands.push(...encoder.encode(`[${copyLabel}] ${copyNum}/${totalCopies}\n`));
            commands.push(...encoder.encode('\n'));
            
            commands.push(...ESC_POS.ALIGN_LEFT);
            commands.push(...encoder.encode(`No: ${order.order_number}\n`));
            commands.push(...encoder.encode(`Waktu: ${new Date().toLocaleString('id-ID')}\n`));
            commands.push(...encoder.encode(`Pembayaran: ONLINE\n`));
            if (order.table) {
                commands.push(...encoder.encode(`Meja: ${order.table}\n`));
            }
            commands.push(...encoder.encode('--------------------------------\n'));
            
            if (order.items && order.items.length > 0) {
                for (const item of order.items) {
                    commands.push(...encoder.encode(`${item.name}\n`));
                    commands.push(...encoder.encode(`  x${item.quantity}     Rp ${formatNumber(item.subtotal)}\n`));
                }
            }
            
            commands.push(...encoder.encode('--------------------------------\n'));
            commands.push(...encoder.encode(`Subtotal:    Rp ${formatNumber(order.subtotal)}\n`));
            if (order.discount > 0) {
                commands.push(...encoder.encode(`Diskon:      Rp ${formatNumber(order.discount)}\n`));
            }
            commands.push(...encoder.encode(`Pajak:       Rp ${formatNumber(order.tax)}\n`));
            commands.push(...ESC_POS.BOLD_ON);
            commands.push(...encoder.encode(`TOTAL:       Rp ${formatNumber(order.total)}\n`));
            commands.push(...ESC_POS.BOLD_OFF);
            commands.push(...encoder.encode('--------------------------------\n'));
            commands.push(...encoder.encode(`Dibayar:     Rp ${formatNumber(order.total)}\n`));
            commands.push(...encoder.encode('\n'));
            commands.push(...ESC_POS.ALIGN_CENTER);
            commands.push(...encoder.encode('*** LUNAS ***\n'));
            commands.push(...encoder.encode('\nTerima kasih!\n'));
            commands.push(...encoder.encode('================================\n'));
            commands.push(...ESC_POS.FEED_LINES(4));
            commands.push(...ESC_POS.CUT_PAPER);
            
            return commands;
        }
        
        // Save receipt to server queue for Printer Station
        async function saveReceiptToServerQueue(order, copies = 3) {
            try {
                for (let i = 1; i <= copies; i++) {
                    const commands = buildReceiptCommands(order, i, copies);
                    
                    await fetch('/api/pending-prints', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order_id: order.id,
                            receipt_data: commands,
                            copies: copies,
                            current_copy: i
                        })
                    });
                }
                console.log(`Receipt saved to server queue (${copies} copies)`);
            } catch (error) {
                console.error('Error saving receipt to queue:', error);
            }
        }
        
        function openPayment() {
            if (!snapToken) {
                showStatus('error');
                return;
            }
            
            snap.pay(snapToken, {
                onSuccess: function(result) {
                    console.log('Payment success:', result);
                    updatePaymentStatus('paid', result);
                    showStatus('success');
                    
                    // Save receipt to server queue for Printer Station
                    console.log('Saving receipt to server queue for online payment...');
                    saveReceiptToServerQueue(orderData, 3);
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        window.location.href = "{{ url_for('orders') }}";
                    }, 3000);
                },
                onPending: function(result) {
                    console.log('Payment pending:', result);
                    updatePaymentStatus('pending', result);
                    showStatus('pending');
                },
                onError: function(result) {
                    console.log('Payment error:', result);
                    updatePaymentStatus('failed', result);
                    showStatus('error');
                },
                onClose: function() {
                    console.log('Payment popup closed');
                }
            });
        }
        
        function updatePaymentStatus(status, result) {
            fetch(`/api/payment/${orderId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status, result: result })
            });
        }
        
        function showStatus(status) {
            document.getElementById('payButton').classList.add('hidden');
            document.getElementById('statusDisplay').classList.remove('hidden');
            document.getElementById('backButton').classList.remove('hidden');
            
            if (status === 'success') {
                document.getElementById('successStatus').classList.remove('hidden');
            } else if (status === 'pending') {
                document.getElementById('pendingStatus').classList.remove('hidden');
            } else if (status === 'error') {
                document.getElementById('errorStatus').classList.remove('hidden');
            }
        }
        
        // Auto-open payment if snap token exists
        {% if auto_pay %}
        window.onload = function() {
            setTimeout(openPayment, 500);
        };
        {% endif %}
    </script>
</body>
</html>
