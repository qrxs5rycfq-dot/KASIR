<!-- Mobile Menu Toggle Button -->
<button id="mobile-menu-btn" onclick="toggleMobileSidebar()" class="md:hidden fixed top-4 left-4 z-50 w-10 h-10 bg-gray-800 rounded-xl flex items-center justify-center text-white shadow-lg">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar Overlay (Mobile) -->
<div id="sidebar-overlay" onclick="toggleMobileSidebar()" class="md:hidden fixed inset-0 bg-black/50 z-40 hidden"></div>

<style>
    /* Sidebar collapsed state (desktop only) */
    @media (min-width: 768px) {
        #sidebar.sidebar-collapsed { width: 5rem; }
        #sidebar.sidebar-collapsed .sidebar-label,
        #sidebar.sidebar-collapsed .sidebar-section-title,
        #sidebar.sidebar-collapsed .sidebar-branch-text,
        #sidebar.sidebar-collapsed .sidebar-external-icon { display: none; }
        #sidebar.sidebar-collapsed .sidebar-link { justify-content: center; padding-left: 0; padding-right: 0; }
        #sidebar.sidebar-collapsed .sidebar-link i.w-5 { width: auto; font-size: 1.1rem; }
        #sidebar.sidebar-collapsed .sidebar-logo-text { display: none; }
        #sidebar.sidebar-collapsed .sidebar-logo-img { margin: 0 auto; }
        #sidebar.sidebar-collapsed .sidebar-inner { padding: 1rem 0.75rem; }
        #sidebar.sidebar-collapsed .sidebar-branch-box { padding: 0.5rem; justify-content: center; }
        #sidebar.sidebar-collapsed .sidebar-branch-box i { margin: 0; }
        #sidebar.sidebar-collapsed .sidebar-collapse-btn i { transform: rotate(180deg); }
    }
</style>

<!-- Sidebar Navigation - Reusable Partial -->
<aside id="sidebar" class="w-64 glass-dark fixed h-full z-40 transition-all duration-300 -translate-x-full md:translate-x-0 flex flex-col">
    <div class="p-6 flex-1 overflow-y-auto sidebar-inner">
        <!-- Close Button (Mobile) -->
        <button onclick="toggleMobileSidebar()" class="md:hidden absolute top-4 right-4 w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center text-gray-400 hover:text-white">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Logo -->
        <div class="flex items-center space-x-3 mb-4 overflow-hidden">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Dapoer Teras Obor" class="sidebar-logo-img w-10 h-10 rounded-xl object-contain flex-shrink-0">
            <span class="sidebar-logo-text text-xl font-display font-bold gradient-text truncate" title="Dapoer Teras Obor">Dapoer Teras Obor</span>
        </div>
        
        <!-- Current Branch Indicator -->
        <div class="sidebar-branch-box mb-6 px-3 py-2 rounded-xl bg-white/5 border border-white/10 flex items-center space-x-2" title="{% if is_owner %}Semua Cabang (Owner){% elif current_branch %}{{ current_branch.name }}{% else %}Cabang belum ditetapkan{% endif %}">
            <i class="fas fa-store text-primary-400 text-sm flex-shrink-0"></i>
            {% if is_owner %}
                <span class="sidebar-branch-text text-xs text-primary-400 font-medium">Semua Cabang (Owner)</span>
            {% elif current_branch %}
                <span class="sidebar-branch-text text-xs text-gray-300 font-medium">{{ current_branch.name }}</span>
            {% else %}
                <span class="sidebar-branch-text text-xs text-gray-400">Cabang belum ditetapkan</span>
            {% endif %}
        </div>
        
        <!-- Navigation -->
        <nav class="space-y-2">
            <a href="{{ url_for('dashboard') }}" title="Dashboard" class="sidebar-link {% if active_page == 'dashboard' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'dashboard' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-home w-5"></i>
                <span class="sidebar-label">Dashboard</span>
            </a>
            
            <a href="{{ url_for('pos') }}" title="Kasir / POS" class="sidebar-link {% if active_page == 'pos' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'pos' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-cash-register w-5"></i>
                <span class="sidebar-label">Kasir / POS</span>
            </a>
            
            <a href="{{ url_for('orders') }}" title="Pesanan" class="sidebar-link {% if active_page == 'orders' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'orders' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-receipt w-5"></i>
                <span class="sidebar-label">Pesanan</span>
            </a>
            
            <a href="{{ url_for('kitchen') }}" title="Dapur" class="sidebar-link {% if active_page == 'kitchen' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'kitchen' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-fire-burner w-5"></i>
                <span class="sidebar-label">Dapur</span>
            </a>
            
            <a href="{{ url_for('reports') }}" title="Laporan" class="sidebar-link {% if active_page == 'reports' or active_page == 'income_report' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'reports' or active_page == 'income_report' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-chart-bar w-5"></i>
                <span class="sidebar-label">Laporan</span>
            </a>
            
            <a href="{{ url_for('analytics') }}" title="Analitik" class="sidebar-link {% if active_page == 'analytics' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'analytics' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-chart-pie w-5"></i>
                <span class="sidebar-label">Analitik</span>
            </a>
            
            <a href="{{ url_for('expenses') }}" title="Pengeluaran" class="sidebar-link {% if active_page == 'expenses' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'expenses' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                <i class="fas fa-wallet w-5"></i>
                <span class="sidebar-label">Pengeluaran</span>
            </a>
            
            {% if current_user.has_role('admin') or current_user.has_role('manager') %}
            <!-- Admin Section -->
            <div class="pt-4 mt-4 border-t border-white/10">
                <p class="sidebar-section-title px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Admin</p>
                
                <a href="{{ url_for('admin_users') }}" title="Pengguna" class="sidebar-link {% if active_page == 'admin_users' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_users' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-users-cog w-5"></i>
                    <span class="sidebar-label">Pengguna</span>
                </a>
                
                <a href="{{ url_for('admin_menu') }}" title="Menu" class="sidebar-link {% if active_page == 'admin_menu' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_menu' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-utensils w-5"></i>
                    <span class="sidebar-label">Menu</span>
                </a>
                
                <a href="{{ url_for('admin_tables') }}" title="Meja" class="sidebar-link {% if active_page == 'admin_tables' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_tables' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-chair w-5"></i>
                    <span class="sidebar-label">Meja</span>
                </a>
                
                <a href="{{ url_for('admin_discounts') }}" title="Diskon & Promo" class="sidebar-link {% if active_page == 'admin_discounts' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_discounts' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-tag w-5"></i>
                    <span class="sidebar-label">Diskon & Promo</span>
                </a>
                
                <a href="{{ url_for('admin_branches') }}" title="Cabang" class="sidebar-link {% if active_page == 'admin_branches' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_branches' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-store w-5"></i>
                    <span class="sidebar-label">Cabang</span>
                </a>
                
                <a href="{{ url_for('admin_cities') }}" title="Kota" class="sidebar-link {% if active_page == 'admin_cities' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_cities' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-city w-5"></i>
                    <span class="sidebar-label">Kota</span>
                </a>
                
                <a href="{{ url_for('admin_brands') }}" title="Brand" class="sidebar-link {% if active_page == 'admin_brands' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_brands' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-tags w-5"></i>
                    <span class="sidebar-label">Brand</span>
                </a>
                
                <a href="{{ url_for('printer_station') }}" title="Printer Station" target="_blank" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white">
                    <i class="fas fa-print w-5"></i>
                    <span class="sidebar-label">Printer Station</span>
                    <i class="sidebar-external-icon fas fa-external-link-alt text-xs ml-auto"></i>
                </a>
                
                <a href="{{ url_for('admin_payment_gateway') }}" title="Payment Gateway" class="sidebar-link {% if active_page == 'admin_payment_gateway' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_payment_gateway' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-credit-card w-5"></i>
                    <span class="sidebar-label">Payment Gateway</span>
                </a>
                
                <a href="{{ url_for('admin_integrations') }}" title="Integrasi Platform" class="sidebar-link {% if active_page == 'admin_integrations' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'admin_integrations' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-plug w-5"></i>
                    <span class="sidebar-label">Integrasi Platform</span>
                </a>
            </div>
            {% endif %}
            
            <!-- User Section -->
            <div class="pt-4 mt-4 border-t border-white/10">
                <a href="{{ url_for('profile') }}" title="Profil" class="sidebar-link {% if active_page == 'profile' %}active{% endif %} flex items-center space-x-3 px-4 py-3 rounded-xl {% if active_page == 'profile' %}text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                    <i class="fas fa-user-circle w-5"></i>
                    <span class="sidebar-label">Profil</span>
                </a>
                <a href="{{ url_for('logout') }}" title="Logout" class="sidebar-link flex items-center space-x-3 px-4 py-3 rounded-xl text-red-400 hover:text-red-300">
                    <i class="fas fa-sign-out-alt w-5"></i>
                    <span class="sidebar-label">Logout</span>
                </a>
            </div>
        </nav>
    </div>
    
    <!-- Desktop Collapse Toggle (at bottom of sidebar) -->
    <div class="hidden md:flex p-3 border-t border-white/10 justify-center">
        <button id="sidebar-collapse-btn" onclick="toggleDesktopSidebar()" class="sidebar-collapse-btn w-full flex items-center justify-center py-2 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors" title="Toggle Sidebar">
            <i class="fas fa-chevron-left transition-transform duration-300"></i>
            <span class="sidebar-label ml-2 text-sm">Tutup Sidebar</span>
        </button>
    </div>
</aside>

<!-- PrinterManager is loaded from base.html - no need to load again -->

<script>
// Mobile sidebar toggle
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const isOpen = !sidebar.classList.contains('-translate-x-full');
    
    if (isOpen) {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    } else {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
    }
}

// Desktop sidebar collapse/expand
function toggleDesktopSidebar() {
    const sidebar = document.getElementById('sidebar');
    const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
    
    if (isCollapsed) {
        sidebar.classList.remove('sidebar-collapsed');
        localStorage.setItem('sidebar-collapsed', 'false');
        updateMainContentMargin(false);
    } else {
        sidebar.classList.add('sidebar-collapsed');
        localStorage.setItem('sidebar-collapsed', 'true');
        updateMainContentMargin(true);
    }
}

function updateMainContentMargin(collapsed) {
    // Update main content areas - select <main> elements which is the standard content wrapper
    const mainEls = document.querySelectorAll('main');
    mainEls.forEach(el => {
        if (collapsed) {
            el.classList.remove('md:ml-64');
            el.classList.add('md:ml-20');
        } else {
            el.classList.remove('md:ml-20');
            el.classList.add('md:ml-64');
        }
    });
}

// Restore sidebar state from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (isCollapsed && window.innerWidth >= 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('sidebar-collapsed');
        updateMainContentMargin(true);
    }
});

// Keep backward compatibility - toggleSidebar is used by some pages
function toggleSidebar() { toggleMobileSidebar(); }
</script>
